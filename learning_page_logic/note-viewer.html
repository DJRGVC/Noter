<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Note Viewer - StudyHub</title>
    <link rel="stylesheet" href="css/modern.css">
    <style>
        .note-viewer-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .note-content-panel {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            background: white;
        }

        .assistant-panel {
            width: 400px;
            background: #f9fafb;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }

        .assistant-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            background: white;
        }

        .assistant-header h3 {
            margin: 0;
            font-size: 1.1em;
            color: #1f2937;
            font-weight: 600;
        }

        .assistant-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 8px;
            max-width: 85%;
        }

        .user-message {
            background: #3b82f6;
            color: white;
            margin-left: auto;
        }

        .bot-message {
            background: white;
            border: 1px solid #e5e7eb;
            color: #1f2937;
        }

        .assistant-input-area {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            background: white;
        }

        .assistant-input-area textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            resize: none;
            font-family: inherit;
            font-size: 0.95em;
        }

        .assistant-input-area button {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .assistant-input-area button:hover {
            background: #2563eb;
        }

        .assistant-input-area button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .back-button {
            display: inline-block;
            padding: 8px 16px;
            background: #f3f4f6;
            color: #4b5563;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9em;
            margin-bottom: 20px;
            transition: background 0.2s;
        }

        .back-button:hover {
            background: #e5e7eb;
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="note-viewer-container">
        <!-- Note Content Panel -->
        <div class="note-content-panel" id="noteContent">
            <a href="index.html" class="back-button">← Back to Dashboard</a>
            <div class="loading-message">Loading note...</div>
        </div>

        <!-- Assistant Panel -->
        <div class="assistant-panel">
            <div class="assistant-header">
                <h3>Study Assistant</h3>
                <p style="margin: 4px 0 0 0; font-size: 0.85em; color: #6b7280;">Ask questions about this note</p>
            </div>
            <div class="assistant-messages" id="messages">
                <div class="message bot-message">
                    <p style="margin: 0;">Loading note content... I'll be ready to help you once it's loaded!</p>
                </div>
            </div>
            <div class="assistant-input-area">
                <textarea id="questionInput" placeholder="Ask a question about this note..." rows="3"></textarea>
                <button id="sendBtn" disabled>Send Question</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001';
        let noteContent = '';
        let noteTitle = '';

        // Get note path from URL
        const urlParams = new URLSearchParams(window.location.search);
        const notePath = urlParams.get('path');

        // Load note content
        async function loadNote() {
            if (!notePath) {
                document.getElementById('noteContent').innerHTML = '<p>Error: No note path specified</p>';
                return;
            }

            try {
                const response = await fetch(notePath);
                const html = await response.text();
                
                // Extract title from HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                noteTitle = doc.querySelector('h1')?.textContent || doc.querySelector('title')?.textContent || 'Note';
                
                // Display the note
                document.getElementById('noteContent').innerHTML = 
                    `<a href="index.html" class="back-button">← Back to Dashboard</a>` + html;
                
                // Store content for assistant
                noteContent = doc.body.textContent;
                
                // Initialize assistant
                initializeAssistant();
                
                // Enable send button
                document.getElementById('sendBtn').disabled = false;
            } catch (error) {
                console.error('Error loading note:', error);
                document.getElementById('noteContent').innerHTML = `<p>Error loading note: ${error.message}</p>`;
            }
        }

        function initializeAssistant() {
            const messages = document.getElementById('messages');
            messages.innerHTML = `
                <div class="message bot-message">
                    <p style="margin: 0;">Hi! I've read through "${noteTitle}". Ask me anything about this note!</p>
                </div>
            `;
        }

        function addMessage(text, isUser = false) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.innerHTML = `<p style="margin: 0;">${text}</p>`;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function showTypingIndicator() {
            const messages = document.getElementById('messages');
            const indicator = document.createElement('div');
            indicator.className = 'message bot-message typing-indicator';
            indicator.id = 'typing';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            messages.appendChild(indicator);
            messages.scrollTop = messages.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing');
            if (indicator) indicator.remove();
        }

        async function sendQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            
            if (!question) return;
            
            // Add user message
            addMessage(question, true);
            input.value = '';
            
            // Disable send button
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Call backend API (not direct Claude API to avoid CORS)
                const response = await fetch(`${API_BASE}/api/ask-about-note`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question,
                        noteContent: noteContent,
                        noteTitle: noteTitle
                    })
                });
                
                const data = await response.json();
                
                hideTypingIndicator();
                
                if (data.error) {
                    addMessage('Sorry, I encountered an error: ' + data.error, false);
                } else {
                    addMessage(data.answer, false);
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage('Sorry, I encountered an error. Make sure the backend server is running.', false);
                console.error('Error:', error);
            } finally {
                sendBtn.disabled = false;
            }
        }

        // Event listeners
        document.getElementById('sendBtn').addEventListener('click', sendQuestion);
        document.getElementById('questionInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendQuestion();
            }
        });

        // Load note on page load
        loadNote();
    </script>
</body>
</html>
