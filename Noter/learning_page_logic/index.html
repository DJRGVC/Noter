<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyHub - Your Personal Learning Space</title>
    <link rel="stylesheet" href="css/modern.css">
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-content">
            <h1 class="section-title">
                <span class="section-title-icon">üìö</span>
                StudyHub
            </h1>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Learn</div>
                    <a href="index.html" class="nav-item active">
                        <span class="nav-icon">üìù</span>
                        <span class="nav-label">Notes</span>
                    </a>
                    <a href="pages/flashcards-view.html" class="nav-item">
                        <span class="nav-icon">üé¥</span>
                        <span class="nav-label">Flashcards</span>
                    </a>
                    <a href="pages/quizzes.html" class="nav-item">
                        <span class="nav-icon">üìã</span>
                        <span class="nav-label">Quizzes</span>
                    </a>
                    <a href="pages/animations.html" class="nav-item">
                        <span class="nav-icon">üé¨</span>
                        <span class="nav-label">Animations</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <div class="dashboard-container">
                <!-- Header -->
                <header class="dashboard-header">
                    <h1>My Notes</h1>
                    <p class="subtitle">Your personal knowledge base</p>
                </header>

                <!-- Classes Container -->
                <div id="classesContainer" style="margin-bottom: 30px;">
                    <div class="loading-message" id="loadingMessage" style="text-align: center; padding: 40px;">
                        <p style="font-size: 1.2em; color: #666;">Loading your classes...</p>
                    </div>
                </div>

                <!-- Add New Buttons -->
                <div style="display: flex; gap: 15px; margin-bottom: 30px; justify-content: center;">
                    <button onclick="showAddClassModal()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 4px; font-size: 0.95em; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.12); font-weight: 500; transition: all 0.2s;">
                        + Add Class
                    </button>
                    <button onclick="showAddNoteModal()" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 4px; font-size: 0.95em; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.12); font-weight: 500; transition: all 0.2s;">
                        + Record Note
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- General Assistant Chat Bubble -->
    <div id="chatBubble" style="position: fixed; bottom: 30px; right: 30px; z-index: 1000;">
        <button id="chatToggle" onclick="toggleChat()" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; font-size: 1.5em; transition: all 0.3s;">
            üí¨
        </button>
        <div id="chatWindow" style="display: none; position: absolute; bottom: 80px; right: 0; width: 350px; height: 500px; background: white; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.3); flex-direction: column; overflow: hidden;">
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin: 0; font-size: 1.1em;">Study Assistant</h3>
                    <p style="margin: 4px 0 0 0; font-size: 0.85em; opacity: 0.9;">Ask me about your notes!</p>
                </div>
                <button onclick="toggleChat()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 0; width: 30px; height: 30px;">√ó</button>
            </div>
            <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 20px; background: #f9fafb;">
                <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <p style="margin: 0; color: #374151; font-size: 0.9em;">Hi! I'm your study assistant. Ask me about your classes, find notes, or get help navigating your materials.</p>
                </div>
            </div>
            <div style="padding: 15px; background: white; border-top: 1px solid #e5e7eb;">
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="chatInput" placeholder="Ask me anything..." onkeypress="if(event.key==='Enter') sendChatMessage()" style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9em;">
                    <button onclick="sendChatMessage()" style="padding: 10px 16px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Class Modal -->
    <div id="addClassModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
            <h2 style="margin-bottom: 20px;">Add New Class</h2>
            <input type="text" id="newClassName" placeholder="Enter class name (e.g., Math, Physics)" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeAddClassModal()" style="padding: 10px 20px; background: #e2e8f0; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
                <button onclick="createNewClass()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; cursor: pointer;">Create</button>
            </div>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div id="addNoteModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
            <h2 style="margin-bottom: 20px;">Record New Note</h2>
            <select id="noteClass" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; margin-bottom: 15px;">
                <option value="">Select a class...</option>
            </select>
            <input type="number" id="noteLectureNum" placeholder="Lecture number (e.g., 1, 2, 3)" min="1" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em; margin-bottom: 20px;">
            <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">Make sure you have created l{num}.txt (and optionally l{num}.pdf and l{num}.py) in the class folder first.</p>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeAddNoteModal()" style="padding: 10px 20px; background: #e2e8f0; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
                <button onclick="createNewNote()" style="padding: 10px 20px; background: linear-gradient(135deg, #f093fb, #f5576c); color: white; border: none; border-radius: 8px; cursor: pointer;">Generate Note</button>
            </div>
            <div id="noteCreationStatus" style="margin-top: 15px; padding: 10px; border-radius: 8px; display: none;"></div>
        </div>
    </div>

    <!-- <script src="js/claude-service.js"></script>
    <script src="js/dashboard.js"></script> -->
    <script>
        const API_BASE = 'http://localhost:5001';
        let allClasses = {};

        // Load all notes on page load
        async function loadAllNotes() {
            try {
                const response = await fetch(`${API_BASE}/api/list-notes`);
                const data = await response.json();
                allClasses = data.classes;
                displayClasses(data.classes);
            } catch (error) {
                console.error('Error loading notes:', error);
                document.getElementById('loadingMessage').innerHTML =
                    '<p style="color: #f56565;">Error loading notes. Make sure the backend server is running on port 5001.</p>' +
                    '<p style="font-size: 0.9em; color: #666; margin-top: 10px;">Run: python3 backend_server.py</p>';
            }
        }

        function displayClasses(classes) {
            const container = document.getElementById('classesContainer');
            container.innerHTML = '';

            if (Object.keys(classes).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No classes found. Click "Add Class" to get started.</p>';
                return;
            }

            // Class color mapping
            const classColors = {
                'cs': '#3b82f6',
                'bio': '#10b981',
                'history': '#f59e0b',
                'philo': '#8b5cf6',
                'philosophy': '#8b5cf6',
                'math': '#ef4444',
                'physics': '#06b6d4',
                'chemistry': '#ec4899'
            };

            // Create grid of class cards
            const gridContainer = document.createElement('div');
            gridContainer.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;';

            for (const [className, notes] of Object.entries(classes)) {
                const classColor = classColors[className.toLowerCase()] || '#6b7280';
                const classDisplayName = className.charAt(0).toUpperCase() + className.slice(1);

                const classCard = document.createElement('div');
                classCard.style.cssText = 'background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; border-top: 4px solid ' + classColor;
                classCard.onclick = () => toggleClass(className);

                classCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h2 style="margin: 0; font-size: 1.25em; font-weight: 600; color: #1f2937;">${classDisplayName}</h2>
                        <span id="toggle-icon-${className}" style="color: #9ca3af; transition: transform 0.2s;">‚Ä∫</span>
                    </div>
                    <p style="margin: 0; color: #6b7280; font-size: 0.9em;">${notes.length} note${notes.length !== 1 ? 's' : ''}</p>
                `;

                classCard.addEventListener('mouseenter', function() {
                    this.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                    this.style.transform = 'translateY(-2px)';
                });

                classCard.addEventListener('mouseleave', function() {
                    this.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                    this.style.transform = 'translateY(0)';
                });

                gridContainer.appendChild(classCard);

                // Create notes container (hidden by default)
                const notesContainer = document.createElement('div');
                notesContainer.id = `notes-${className}`;
                notesContainer.style.cssText = 'display: none; grid-column: 1 / -1; background: #f9fafb; border-radius: 8px; padding: 20px; margin-top: -20px;';
                notesContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        ${notes.map(note => `
                            <a href="note-viewer.html?path=${encodeURIComponent(note.path)}" style="display: block; background: white; border-radius: 6px; padding: 16px; text-decoration: none; color: inherit; transition: all 0.2s; border: 1px solid #e5e7eb;">
                                <h3 style="margin: 0 0 8px 0; color: #1f2937; font-size: 0.95em; font-weight: 600;">${note.title}</h3>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                                    <span style="background: ${classColor}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.75em; font-weight: 500;">${classDisplayName}</span>
                                    <span style="color: #9ca3af; font-size: 0.8em;">${note.filename}</span>
                                </div>
                            </a>
                        `).join('')}
                    </div>
                `;
                gridContainer.appendChild(notesContainer);
            }

            container.appendChild(gridContainer);

            // Add hover effects to note cards
            setTimeout(() => {
                document.querySelectorAll('a[href^="note-viewer.html"]').forEach(card => {
                    card.addEventListener('mouseenter', function() {
                        this.style.borderColor = '#3b82f6';
                        this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                    });
                    card.addEventListener('mouseleave', function() {
                        this.style.borderColor = '#e5e7eb';
                        this.style.boxShadow = 'none';
                    });
                });
            }, 100);
        }

        function toggleClass(className) {
            const notesDiv = document.getElementById(`notes-${className}`);
            const toggleIcon = document.getElementById(`toggle-icon-${className}`);

            if (notesDiv.style.display === 'none' || notesDiv.style.display === '') {
                notesDiv.style.display = 'block';
                toggleIcon.style.transform = 'rotate(90deg)';
            } else {
                notesDiv.style.display = 'none';
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        }

        function showAddClassModal() {
            document.getElementById('addClassModal').style.display = 'flex';
        }

        function closeAddClassModal() {
            document.getElementById('addClassModal').style.display = 'none';
            document.getElementById('newClassName').value = '';
        }

        async function createNewClass() {
            const className = document.getElementById('newClassName').value.trim();
            if (!className) {
                alert('Please enter a class name');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/create-class`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ class_name: className })
                });

                const data = await response.json();
                if (data.success) {
                    alert(`Class "${className}" created successfully!`);
                    closeAddClassModal();
                    loadAllNotes(); // Reload
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error creating class: ' + error.message);
            }
        }

        function showAddNoteModal() {
            // Populate class dropdown
            const select = document.getElementById('noteClass');
            select.innerHTML = '<option value="">Select a class...</option>';

            for (const className of Object.keys(allClasses)) {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className.charAt(0).toUpperCase() + className.slice(1);
                select.appendChild(option);
            }

            document.getElementById('addNoteModal').style.display = 'flex';
        }

        function closeAddNoteModal() {
            document.getElementById('addNoteModal').style.display = 'none';
            document.getElementById('noteClass').value = '';
            document.getElementById('noteLectureNum').value = '';
            document.getElementById('noteCreationStatus').style.display = 'none';
        }

        async function createNewNote() {
            const className = document.getElementById('noteClass').value;
            const lectureNum = document.getElementById('noteLectureNum').value;
            const statusDiv = document.getElementById('noteCreationStatus');

            if (!className || !lectureNum) {
                alert('Please select a class and enter a lecture number');
                return;
            }

            statusDiv.style.display = 'block';
            statusDiv.style.background = '#bee3f8';
            statusDiv.style.color = '#2c5282';
            statusDiv.textContent = '‚è≥ Generating note... This may take a minute.';

            try {
                const response = await fetch(`${API_BASE}/api/create-note`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ class_name: className, lecture_num: lectureNum })
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.style.background = '#c6f6d5';
                    statusDiv.style.color = '#22543d';
                    statusDiv.textContent = '‚úÖ Note generated successfully!';
                    setTimeout(() => {
                        closeAddNoteModal();
                        loadAllNotes(); // Reload to show new note
                    }, 2000);
                } else {
                    statusDiv.style.background = '#fed7d7';
                    statusDiv.style.color = '#742a2a';
                    statusDiv.textContent = '‚ùå Error: ' + data.error;
                }
            } catch (error) {
                statusDiv.style.background = '#fed7d7';
                statusDiv.style.color = '#742a2a';
                statusDiv.textContent = '‚ùå Error: ' + error.message;
            }
        }

        // Load notes when page loads
        loadAllNotes();

        // Chat functions
        function toggleChat() {
            const chatWindow = document.getElementById('chatWindow');
            if (chatWindow.style.display === 'none' || chatWindow.style.display === '') {
                chatWindow.style.display = 'flex';
            } else {
                chatWindow.style.display = 'none';
            }
        }

        function addChatMessage(text, isUser = false) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `background: ${isUser ? 'linear-gradient(135deg, #667eea, #764ba2)' : 'white'}; color: ${isUser ? 'white' : '#374151'}; padding: 12px; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-left: ${isUser ? 'auto' : '0'}; margin-right: ${isUser ? '0' : 'auto'}; max-width: 85%;`;
            messageDiv.innerHTML = `<p style="margin: 0; font-size: 0.9em;">${text}</p>`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesDiv = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.style.cssText = 'background: white; padding: 12px; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); max-width: 85%;';
            typingDiv.innerHTML = '<p style="margin: 0; font-size: 0.9em; color: #9ca3af;">Thinking...</p>';
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingDiv = document.getElementById('typingIndicator');
            if (typingDiv) typingDiv.remove();
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Add user message
            addChatMessage(message, true);
            input.value = '';

            // Show typing indicator
            showTypingIndicator();

            try {
                // Create context with all available notes
                let notesContext = "Available classes and notes:\n";
                for (const [className, notes] of Object.entries(allClasses)) {
                    notesContext += `\n${className}:\n`;
                    notes.forEach(note => {
                        notesContext += `  - ${note.title} (${note.filename})\n`;
                    });
                }

                const response = await fetch(`${API_BASE}/api/ask-about-note`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: message,
                        noteContent: notesContext,
                        noteTitle: 'StudyHub Dashboard'
                    })
                });

                const data = await response.json();

                removeTypingIndicator();

                if (data.error) {
                    addChatMessage('Sorry, I encountered an error: ' + data.error, false);
                } else {
                    addChatMessage(data.answer, false);
                }
            } catch (error) {
                removeTypingIndicator();
                addChatMessage('Sorry, I encountered an error. Please make sure the backend is running.', false);
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
